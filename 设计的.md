# 项目设计说明（Python + MuMu + PaddleOCR）

## 1. 设计目标
- 多账号多区服自动化：起号、寄养、探索/结界突破、结界卡合成、委托/弥助、勾协、加好友、休息策略。
- 可运维：本地 Web 管理；可观测：统一日志/DB；可扩展：模块/任务插件化；可配置：.env/配置文件。

## 2. 技术栈与依赖
- 语言/运行：Python 3.10+；包管理：`pip`/`uv`。
- Web 管理：FastAPI + Uvicorn。
- 调度：APScheduler（时间窗）+ 内部优先级队列（条件触发）。
- ORM/数据库：SQLAlchemy + Alembic（迁移）；SQLite/PostgreSQL（二选一）。
- 视觉：OpenCV（模板匹配）+ PaddleOCR（中文模型）。
- 模拟器：MuMu 官方策略（多开管理 + ADB 控制）。
- 配置/日志：Pydantic Settings + loguru；重试：tenacity。

## 3. 目录结构（建议）
```
src/
  app/
    core/            # 配置、日志、常量与枚举
    db/              # ORM 模型、会话、迁移钩子
    modules/
      accounts/      # 账号服务（邮箱外键、4个账号规则）
      tasks/         # 调度器、队列、状态机
      executor/      # 执行引擎、并发/资源管理
      emu/           # MuMu 适配器（ADB+Manager）
      vision/        # OpenCV 模板匹配、截屏管线
      ocr/           # PaddleOCR 封装（ROI/缓存）
      coop/          # 勾协逻辑与池管理
      web/           # FastAPI 路由与UI
    plugins/tasks/   # 起号/寄养/探索/合成/委托/勾协/好友/休息
  scripts/           # dev/test/build
tests/               # pytest
docs/                # 设计文档与图示
```

## 4. 关键原则与架构补充
- 执行器内置：基于截图/模板匹配点击的"大型执行器"作为本进程模块，由调度器调用对应任务插件（不在此阶段实现具体点击逻辑）。
  - 执行器实现为接口/抽象类，具体操作暂时返回模拟成功
  - Worker是执行器的线程实例，数量与配置的模拟器相关
- 推送式分发：调度器从优先级队列出队任务，绑定空闲 Worker/模拟器后触发执行；通过任务锁与配额控制并发与抢占。
- 起号策略：
  - 新录入邮箱账号后，调度器不主动创建 4 个区服账号
  - 执行器完成起号后调用 API 更新起号状态（`POST /api/accounts/init-status`）
  - 账号状态：1=可执行（正常调度）、2=失效（需人工干预）
  - 起号成功/失败判定由执行器决定，调度系统仅响应状态更新
- 区服配置：
  - 固定4个区服：樱之华、春之樱、两情相悦、枫之舞（优先级递减）
  - 执行器通过 API 获取目标区服信息执行对应任务

## 5. 模拟器集成（MuMu）
- 实例管理：使用官方管理器（示例命令，按版本调整）：
  - 列表/启动/关闭：`MuMuManager.exe list | launch --index N | quit --index N`
  - ADB 映射：`MuMuManager.exe adb --index N`（返回端口）或固定端口如 `127.0.0.1:7555`
- ADB 控制（示例）：
  - 连接：`adb connect 127.0.0.1:7555`
  - 截屏：`adb -s 127.0.0.1:7555 exec-out screencap -p > screen.png`
  - 点击：`adb -s 127.0.0.1:7555 shell input tap X Y`
  - 滑动：`adb -s 127.0.0.1:7555 shell input swipe X1 Y1 X2 Y2 300`
  - 启动/停止游戏：`adb shell monkey -p com.netease.onmyoji -c android.intent.category.LAUNCHER 1` / `adb shell am force-stop com.netease.onmyoji`
- 适配接口（示例）：
  - `EmulatorAdapter.ensure_running() / start_app() / stop_app()`
  - `capture() -> np.ndarray`、`tap(x,y)`、`swipe(x1,y1,x2,y2,dur)`、`foreground()`
  - 统一坐标系（分辨率适配）；前台保障与并发限流。

## 6. 视觉与 OCR
- PaddleOCR：中文模型，懒加载与单例复用；支持 ROI 识别与阈值过滤。
- OpenCV：模板库（按钮/标志）+ 多尺度匹配；像素/色域预处理；置信度阈值与多候选筛选。
- 性能：`exec-out` PNG 截屏→内存解码；最小必要 ROI；缓存最近场景状态。

## 7. 账号体系与数据模型

### 账号体系
- **两种录入方式**：
  - 邮箱账号：创建 Email 记录 → 执行器起号 → 自动创建 GameAccount（含 email_fk）
  - ID账号：直接创建 GameAccount（无 email_fk，独立账号）
- **账号关系**：
  - 一个 Email 最多对应 4 个 GameAccount（不同区服）
  - GameAccount 以 `login_id` 为唯一标识
  - 调度器统一通过 GameAccount 进行任务调度
- **登录数据**：
  - 存储路径：`logindata/{login_id}/`
  - login_id 与 GameAccount.login_id 对应
  - 执行器通过 push logindata 到模拟器实现登录

### 数据模型（SQLAlchemy）
- `Email(email PK, password, created_at)`
- `GameAccount(id PK, login_id UNIQUE, email_fk, zone, level, stamina, coin, progress[init|ok], status[1=可执行|2=失效], current_task, task_config(json))`
  - task_config 结构：`{寄养: {enabled: true, interval: 6}, 委托: {enabled: true}, 勾协: {enabled: true}, 探索: {enabled: true}, ...}`
- `AccountRestConfig(id PK, account_id FK, rest_start, rest_end, rest_duration)` - 账号休息配置
- `Task(id PK, account_id, type, priority, scheduled_at, next_at, conditions(json), status[pending|running|succeeded|failed|skipped], retry_count, max_retries)`
- `CoopPool(id PK, account_id, expire_at, linked_account_id, used_count, created_at)`
- `Emulator(id PK, name, role[coop|general|init], state, adb_addr)`
- `Log(id PK, account_id, type, message, ts)`
- `Worker(id PK, emulator_id FK, role[coop|general|init], state[idle|busy|down], last_beat)`
- `TaskRun(id PK, task_id FK, worker_id FK, emulator_id FK, started_at, finished_at, status, error_code, artifacts(json))`
- `RestPlan(id PK, account_id FK, date, start_time, end_time)` - 每日生成的休息计划

## 8. 调度与任务策略

### 任务分类
- **固定时间点任务**（只能开关）：
  - 委托：每日18:00
  - 勾协：时间点列表（如 ["18:00","21:00"]）
- **可配置间隔任务**（可调整执行间隔）：
  - 寄养：默认每6小时，可配置间隔（1-24小时）
  - 探索/突破：条件触发（体力>1000）+ 可配置冷却时间
- **账号级别控制**：
  - 每个账号可独立开关各项任务
  - 可配置任务支持独立设置执行间隔
  - 休息时间段可按账号独立配置（默认2-3小时随机）

### 调度机制
- 双触发：
  - 时间：APScheduler（处理定时和间隔任务）
  - 条件：体力>1000 触发探索/突破、次数阈值触发合成
- 任务优先级（1-100）：
  - 起号：100（最高优先级，未完成起号的账号不执行其他任务）
  - 勾协：80（时间敏感任务）
  - 委托：70（每日任务）
  - 寄养：60（定时收益）
  - 探索/突破：50（条件触发）
  - 结界卡合成：40
  - 加好友：30
  - 休息：20（最低优先级）
- 规则：
  - 起号：新邮箱录入后不自动建 4 个区服账号；由执行器完成起号并通过 API 更新状态；同邮箱起号串行由调度协调保证
  - 寄养：先领后寄；写回剩余体力；支持账号独立配置执行间隔
  - 委托：每账号每日18:00执行一次（可开关）
  - 休息策略（账号级别配置）：
    - 全局休息：0:00-6:00 固定休眠时段，所有账号暂停调度
    - 账号休息：每个账号可配置独立休息时段
      - 默认：每日随机生成2-3小时休息时段
      - 可配置：自定义休息开始时间和时长（1-5小时）
    - 实现：调度器检查账号是否处于休息期，休息期内跳过该账号所有任务
    - 存储：AccountRestConfig 表存储账号休息配置，RestPlan 表存储每日生成的计划
  - 勾协：T-10 分钟停止分配新任务给 coop 角色；优先历史关联（CoopPool.linked_account_id）→再派未关联；可按账号开关
- 状态机：pending→running→(succeeded|failed|skipped)；失败退避（指数回退）与最大重试；任务幂等

## 9. 任务插件接口
- 抽象：`BaseTask`：`prepare()` 校验前置条件，`execute()` 具体操作，`rollback()` 回滚，`on_success()/on_fail()` 回写计数/状态。
- 插件：起号、寄养、探索、结界突破、合成结界卡、委托/弥助（占位可配置）、勾协、自动加好友、休息。
- 可观测：每步打点与截图留存（按账号/任务ID分目录）。

## 10. 配置与安全
- `.env`：`DATABASE_URL`、`PADDLE_OCR_LANG=ch`、`MUMU_MANAGER_PATH`、`ADB_PATH`、`PKG_NAME=com.netease.onmyoji`、`COOP_TIMES=18:00,21:00`、`STAMINA_THRESHOLD=1000` 等。
- `.env.example` 提供样例；`.gitignore` 忽略日志/截图/本地构建。

## 11. Web 管理（FastAPI）

### 部署与技术栈
- 部署方式：本地运行的单页应用，无需认证（仅本地访问）
- 技术栈：FastAPI + Uvicorn + 原生 HTML/JS（或 Vue/React）
- 实时通信：WebSocket（任务状态、日志流）

### 页面设计

#### 1. 仪表盘（首页）
- 顶部卡片：活跃账号数统计
- 主要区域：实时任务执行列表（账号、任务类型、状态、开始时间、执行时长）
- 任务队列预览：显示待执行的前10个任务

#### 2. 账号管理
- 左侧列表：
  - 树形结构（邮箱账号可展开显示子账号）
  - 状态颜色标记：
    - 绿色：正在执行任务
    - 黄色：休息中
    - 红色：失效（突出显示）
    - 灰色：空闲可调度
  - 快速筛选（全部/可用/失效/休息中）
- 右侧详情：
  - 基础信息：login_id、区服、等级、状态
  - 资源信息：体力、金币（可编辑，修改后触发条件检查）
  - 当前任务：任务类型、开始时间
  - 任务配置：
    - 固定时间任务开关：委托（开/关）、勾协（开/关）
    - 间隔任务配置：寄养（开/关，间隔1-24小时）
    - 条件任务开关：探索/突破（开/关）、结界卡合成（开/关）
  - 休息配置：
    - 休息模式：默认随机/自定义
    - 自定义设置：开始时间、持续时长（1-5小时）
    - 今日休息时段：显示当前生效的休息时间
  - 编辑功能：支持修改体力、金币等数据以触发条件型任务
- 操作栏：
  - 添加邮箱账号
  - 添加ID账号
  - 导入/导出账号列表

#### 3. 任务中心
- 上部 - 任务队列：
  - 待执行任务列表（优先级排序，只读展示）
  - 筛选器：账号/任务类型/优先级
- 下部 - 执行历史：
  - 已完成任务（时间倒序）
  - 状态筛选：成功/失败/跳过
  - 时间范围选择
- 说明：
  - 所有任务由调度器自动管理，不支持手动操作任务
  - 可通过编辑账号数据（如体力值）间接触发条件型任务调度

#### 4. 勾协管理
- 勾协池列表：显示配对关系、使用次数、创建时间
- 勾协时间配置：编辑勾协时间点
- 历史记录：勾协执行历史、成功率统计

#### 5. 系统配置
- 调度参数：
  - 全局休息时间（0-6点）
  - 任务触发时间配置
  - 体力阈值等条件参数
  - 说明：配置修改后需要重启调度器生效
- 运维管理：
  - 数据库备份（手动备份/查看备份）
  - 配置回滚（支持回滚到历史配置）
  - 日志级别设置
  - 日志清理策略

### 前端交互细节
- WebSocket推送：每5秒更新一次任务状态和账号信息
- 实时日志：保留最近1000行，支持日志级别筛选（ERROR/WARN/INFO）
- 账号状态：使用颜色标记（绿/黄/红/灰），失效账号突出显示
- 任务管理：
  - 任务队列只读展示，不支持任何直接操作
  - 通过编辑账号资源数据（体力/金币）间接触发条件型任务
  - 例：修改体力值≥1000触发探索/突破任务
- 配置管理：修改后需重启生效，支持配置回滚

### API 端点
- **账号相关**：
  - `GET /api/accounts` - 账号列表（支持树形结构）
  - `POST /api/accounts/email` - 添加邮箱账号
  - `POST /api/accounts/game` - 添加ID账号
  - `PUT /api/accounts/{id}` - 更新账号状态和资源
  - `PUT /api/accounts/{id}/task-config` - 更新任务配置
    - 请求：`{寄养: {enabled: true, interval: 6}, 委托: {enabled: false}, ...}`
  - `PUT /api/accounts/{id}/rest-config` - 更新休息配置
    - 请求：`{mode: "custom", start_time: "14:00", duration: 3}`
  - `GET /api/accounts/{id}/rest-plan` - 获取今日休息计划
- **任务相关**：
  - `GET /api/tasks/queue` - 任务队列（只读）
  - `GET /api/tasks/history` - 执行历史
- **监控相关**：
  - `GET /api/dashboard` - 仪表盘数据
  - `GET /api/stats/realtime` - 实时统计
  - `WS /ws/logs` - WebSocket 实时日志
  - `WS /ws/tasks` - WebSocket 任务状态
- **配置相关**：
  - `GET /api/config` - 获取配置
  - `PUT /api/config` - 更新配置
  - `POST /api/backup` - 手动备份
  - `GET /api/backups` - 备份列表

## 12. 日志与测试
- 日志：loguru JSON 行日志 + DB 关键事件；按账号分文件滚动；错误堆栈与截图路径关联。
- 测试：pytest；对 ADB/截图/OCR 进行 mock；提供金图（golden images）做模板匹配回归；覆盖率≥80%。

## 13. 开发与运行
- 安装：`pip install -r requirements.txt`（核心依赖：`paddleocr`, `opencv-python`, `numpy`, `fastapi`, `uvicorn`, `sqlalchemy`, `alembic`, `apscheduler`, `loguru`, `tenacity`, `pydantic-settings`）。
- 迁移：
  - Windows：`powershell -ExecutionPolicy Bypass -File scripts/migrate.ps1`
  - Bash：`bash scripts/migrate`
- 本地运行：`scripts/dev`（启动 API + 调度器）；测试：`scripts/test`；打包：`scripts/build`。

## 14. 数据迁移（Alembic）
- 数据库连接：`DATABASE_URL`（默认 `sqlite:///./data.db`）。
- 结构要点：
  - `email_accounts` 保存邮箱与明文密码。
  - `game_accounts` 强制 `login_id` 全局唯一；当存在 `email_account_id` 时自动分配槽位（1–4），并保证 `(email_account_id, slot)` 唯一。
  - 兼容旧库：允许 `email_fk` 为空，避免旧的 NOT NULL 错误。

## 14. 内部接口约定（关键）
- Scheduler 接口：
  - `enqueue(task: Task)`、`dequeue() -> Task|None`、`dispatch(task, worker)`、`retry(task)`、`complete(task, status)`
  - 保障幂等（同一 `task.id` 仅有一个活跃运行），并持久化状态机迁移与 TaskRun 记录。
- Worker/执行器接口（内部模块）：
  - `Worker.pick(task_type, role) -> bool` 判定可接单；`run(task, context)` 执行并回传结果。
  - 与 `EmulatorAdapter` 协作：确保前台、截屏、点击、滑动；不在本文实现具体细节。
- 账号服务 API：
  - `POST /api/accounts/init-status` - 执行器更新起号状态
    - 请求：`{account_id, status: 1|2, zone?, level?, message?}`
    - 响应：`{success: bool, account: {...}}`
  - `GET /api/accounts/{id}/zone` - 获取账号应执行的区服
    - 响应：`{zone: "樱之华"|"春之樱"|"两情相悦"|"枫之舞", priority: 1-4}`
  - `create_game_account(email, zone, progress, level?, stamina?, coin?)`
  - `update_game_account(id, status: 1|2, progress?, stamina?, level?, coin?)`
- 锁与并发：
  - 账号任务互斥：同一游戏账号同时只能执行一个任务，任务完成后才能调度下一个
  - 同邮箱起号串行锁：同一邮箱下的账号起号任务串行执行
  - 勾协前 T-10 限制：勾协时间前10分钟停止给 coop 角色分配新任务
  - 每 Worker 单并发：每个 Worker 同时只能执行一个任务
  - 全局速率限制：控制整体任务执行频率

## 15. 系统运维配置
- 数据库备份：每3天自动备份一次，保留最近3个备份
- 日志策略：按账号分文件，保留3天，超期自动清理
- 调度器监控：任务队列长度、执行成功率、平均等待时间

## 16. 待明确与下一步（执行器相关）
- 探索/突破的具体执行次数限制
- 结界卡合成的触发阈值
- 加好友的触发条件和频率
- 任务重试策略的具体参数（调度器层面已定义状态机）
