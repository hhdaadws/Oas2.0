# 执行器模块设计文档

## 1. 总体架构

### 设计目标
- 支持多种截图方式（ADB、IPC）
- 支持OCR文字识别和模板匹配
- 模块化设计，便于扩展和维护
- 统一的任务执行接口
- 模拟器实例管理和调度

### 核心流程
```
调度器 → 执行器 → 模拟器管理 → 截图 → 图像识别 → 操作执行 → 结果返回
```

## 2. 模块结构

### 2.1 执行器核心 (`executor/`)
```
executor/
├── base.py                 # 执行器基类（已存在，需改进）
├── real_executor.py        # 真实执行器实现
└── worker_manager.py       # Worker管理器
```

**功能**：
- 接收调度器任务
- 分配模拟器资源
- 管理任务执行生命周期
- 异常处理和重试机制

### 2.2 截图模块 (`executor/capture/`)
```
capture/
├── __init__.py
├── base.py                # 截图基类
├── adb_capture.py         # ADB截图实现
└── ipc_capture.py         # IPC截图实现
```

**ADB截图**：
- 命令：`adb -s {adb_addr} exec-out screencap -p > screen.png`
- 优点：稳定可靠，兼容性好
- 缺点：速度相对较慢

**IPC截图**：
- 通过IPC通信获取截图
- 优点：速度快，效率高
- 缺点：需要特殊支持

### 2.3 图像识别模块 (`executor/vision/`)
```
vision/
├── __init__.py
├── ocr.py                 # OCR文字识别
├── template.py            # 模板匹配  
├── detector.py            # 通用检测器
└── utils.py               # 图像处理工具
```

**OCR识别**：
- 使用PaddleOCR中文模型
- ROI区域优化，提高识别精度
- 文字位置和内容提取

**模板匹配**：
- OpenCV模板匹配算法
- 支持多尺度和旋转匹配
- 相似度阈值配置

### 2.4 模拟器管理 (`executor/emulator/`)
```
emulator/
├── __init__.py
├── manager.py             # 模拟器管理器
├── adapter.py             # 模拟器适配器
└── controller.py          # 模拟器控制器
```

**管理器功能**：
- 模拟器实例生命周期管理
- ADB连接状态监控
- 模拟器分配和回收

**适配器功能**：
- 启动/停止游戏应用
- 点击/滑动操作
- 按键事件模拟

### 2.5 任务实现 (`executor/tasks/`)
```
tasks/
├── __init__.py
├── base_task.py           # 任务基类
├── foster.py              # 寄养任务
├── delegate.py            # 委托任务
├── coop.py                # 勾协任务
├── explore.py             # 探索突破任务
├── card_synthesis.py      # 结界卡合成任务
└── add_friend.py          # 加好友任务
```

## 3. 接口设计

### 3.1 截图接口 (`BaseCapture`)
```python
class BaseCapture:
    async def capture(self, device_id: str) -> bytes:
        """截取屏幕图像"""
        pass
    
    def is_available(self, device_id: str) -> bool:
        """检查截图功能是否可用"""
        pass
```

### 3.2 图像识别接口
```python
class OCREngine:
    def recognize_text(self, image: bytes, roi: tuple = None) -> List[TextResult]:
        """识别图像中的文字"""
        pass

class TemplateEngine:
    def match_template(self, image: bytes, template: str, threshold: float = 0.8) -> MatchResult:
        """模板匹配"""
        pass
```

### 3.3 模拟器接口
```python
class EmulatorAdapter:
    async def ensure_running(self) -> bool:
        """确保模拟器运行"""
        pass
    
    async def start_app(self, package_name: str) -> bool:
        """启动应用"""
        pass
    
    async def tap(self, x: int, y: int) -> bool:
        """点击操作"""
        pass
    
    async def swipe(self, x1: int, y1: int, x2: int, y2: int, duration: int = 300) -> bool:
        """滑动操作"""
        pass
```

### 3.4 任务接口
```python
class BaseTask:
    async def execute(self, context: TaskContext) -> TaskResult:
        """执行任务主逻辑"""
        pass
    
    def get_required_resources(self) -> ResourceRequirement:
        """获取任务所需资源"""
        pass
```

## 4. 执行流程

### 4.1 任务执行流程
1. **接收任务**：从调度器获取任务信息
2. **资源分配**：根据任务类型分配合适的模拟器
3. **环境准备**：启动模拟器，打开游戏
4. **任务执行**：
   - 截图获取当前状态
   - OCR识别或模板匹配
   - 决策下一步操作
   - 执行点击/滑动
   - 循环直到完成
5. **结果处理**：更新账号状态，记录执行日志
6. **资源释放**：清理临时文件，释放模拟器

### 4.2 截图策略
- **ADB截图**：默认方式，稳定可靠
- **IPC截图**：高性能模式，需要特殊支持
- **截图缓存**：避免频繁截图，提高效率
- **ROI优化**：只截取关注区域，减少处理时间

### 4.3 识别策略
- **OCR识别**：用于读取文字信息（体力值、金币等）
- **模板匹配**：用于识别UI元素（按钮、图标等）
- **组合识别**：OCR+模板提高识别准确率
- **缓存机制**：常用模板缓存，提高匹配速度

## 5. 配置管理

### 5.1 截图配置
```python
CAPTURE_CONFIG = {
    "method": "adb",  # adb|ipc
    "quality": 80,    # 图像质量
    "timeout": 10,    # 截图超时
    "roi_enable": True,  # 是否启用ROI
    "cache_expire": 2    # 缓存过期时间(秒)
}
```

### 5.2 识别配置
```python
VISION_CONFIG = {
    "ocr": {
        "lang": "ch",
        "det_db_thresh": 0.3,
        "det_db_box_thresh": 0.6
    },
    "template": {
        "threshold": 0.8,
        "scale_range": (0.8, 1.2),
        "rotation_enable": False
    }
}
```

### 5.3 任务配置
```python
TASK_CONFIG = {
    "foster": {
        "timeout": 120,
        "retry_count": 3,
        "templates": ["foster_button", "confirm_button"]
    },
    "explore": {
        "timeout": 300,
        "retry_count": 2,
        "ocr_regions": [(100, 50, 200, 80)]  # 体力值区域
    }
}
```

## 6. 错误处理

### 6.1 异常类型
- `CaptureError`：截图失败
- `RecognitionError`：识别失败
- `EmulatorError`：模拟器异常
- `TaskTimeoutError`：任务超时
- `ResourceBusyError`：资源占用

### 6.2 重试机制
- 截图失败：最多重试3次
- 识别失败：降低阈值重试
- 操作失败：等待后重试
- 模拟器异常：重启模拟器

### 6.3 日志记录
- 执行步骤详细记录
- 截图和识别结果保存
- 异常信息和堆栈跟踪
- 性能指标统计

## 7. 性能优化

### 7.1 并发控制
- Worker池管理
- 模拟器实例复用
- 任务优先级队列

### 7.2 资源优化
- 图像压缩和缓存
- 模板预加载
- 内存使用监控

### 7.3 速度优化
- ROI区域截图
- 增量检测
- 并行处理

## 8. 实现计划

1. **Phase 1**：创建基础框架和接口
2. **Phase 2**：实现ADB截图和基础识别
3. **Phase 3**：实现模拟器管理和控制
4. **Phase 4**：实现具体任务逻辑
5. **Phase 5**：添加IPC截图支持
6. **Phase 6**：性能优化和错误处理完善

这个设计提供了完整的执行器架构，支持您要求的所有功能。现在开始逐个实现这些模块？