# 勾协任务开发文档

## 1. 背景与目标
- 仅支持录入“勾协库”ID账号，和普通游戏账号分表管理。
- 勾协任务在固定时间窗执行，窗口为每日 12:00 与 18:00 自然分段：
  - [当天12:00, 当天18:00) 记为窗口 slot=12（window_date=当天）
  - [当天18:00, 次日12:00) 记为窗口 slot=18（window_date=当天）
- 每个时间段每个勾协库账号最多接收 2 次勾协请求；时间一到自动“归零”，无需手动重置。
- 调度优先使用历史亲和配对（更稳定），并兼顾负载均衡（更公平）。

## 1.1 关键行为补充（确认）
- 普通游戏账号执行“勾协任务”时，只有在运行期“检测到勾协”（即场景中确有可接受的勾协请求）才会触发匹配流程；匹配来自“勾协库”的账号，生成一个“接受勾协”的子任务。
- “接受勾协”子任务只能由“勾协专用模拟器（role=coop）”执行；不得由 general/init 角色执行。
- 计数规则：仅当“接受勾协”子任务执行成功后，才为目标勾协库账号在当前时间窗的 used_count +1；失败不计数，可换下一个候选重试（有限次）。

## 2. 术语
- 发起方（owner）：普通游戏账号（GameAccount），在时间窗内给勾协库账号发送勾协。
- 被勾协方（coop）：勾协库账号（CoopAccount），每窗口最多接收 2 次。
- 时间窗（window）：自然分段的时间区间，slot=12 或 18。

## 3. 需求确认
- 每窗口容量固定为 2（不可配置）。
- 勾协配对表 CoopPool 重建为：`owner_account_id -> game_accounts.id`，`coop_account_id -> coop_accounts.id`。
- 勾协时间窗固定为 12:00 与 18:00（用于容量归零），与任务创建时间配置解耦。

## 4. 已实现与待办
已实现
- 数据表
  - coop_accounts（勾协库）：login_id 唯一；status（1可用/2失效）；zone/note；时间戳。
  - coop_windows（时间窗容量）：唯一键 (coop_account_id, window_date, slot)；used_count；completed_at。
  - coop_pools（配对历史）：(owner_account_id, coop_account_id) 唯一；used_count；last_used_at；时间戳。
- API 路由 `/api/coop`
  - GET /accounts：列表（支持 status/keyword/分页），返回当前窗口用量 used（0/1/2）。
  - POST /accounts：创建勾协库账号。
  - PUT /accounts/{id}：更新状态/zone/note。
  - DELETE /accounts/{id}：删除。
  - POST /accounts/batch-import：批量导入登录ID。
- 启动迁移（SQLite）：自动重建旧的 coop_pools 结构为新结构；创建新表。

待办
- 调度器接入“时间窗限流 + 历史优先 + 均衡”选配算法；在创建勾协任务前占用窗口容量（used_count+1）。
- 创建任务时在 Task.conditions 写入 `{coop_account_id, coop_login_id, window:{date,slot}}`。
- 成功执行后更新 CoopPool（used_count/last_used_at），并把发起方“勾协.next_time”推进到下一窗口起点。
- 前端“勾协管理”页面（/coop）：维护勾协库，展示当前窗口用量、状态切换、批量导入、搜索。
- 将默认 COOP_TIMES 调整为 "12:00,18:00"（仅用于任务检查的时间点；窗口归零逻辑独立存在）。

## 5. 数据模型
### 5.1 CoopAccount（勾协库）
- id PK
- login_id String(255) UNIQUE NOT NULL
- zone String(50) NULL
- status INT 默认1（1可用/2失效）
- note TEXT NULL
- created_at/updated_at

### 5.2 CoopWindow（时间窗容量）
- id PK
- coop_account_id FK->coop_accounts.id
- window_date String(10) YYYY-MM-DD（窗口起始日）
- slot INT（12|18）
- used_count INT 默认0（已接收次数）
- completed_at DATETIME NULL（选填）
- updated_at DATETIME
- 唯一约束：(coop_account_id, window_date, slot)

窗口归属规则：
- now < 当日12:00 → (window_date=昨日, slot=18)
- 12:00 ≤ now < 18:00 → (今日, 12)
- now ≥ 18:00 → (今日, 18)

### 5.3 CoopPool（配对历史/亲和度）
- id PK
- owner_account_id FK->game_accounts.id（发起方）
- coop_account_id FK->coop_accounts.id（被勾协方）
- used_count INT（累计成功次数）
- last_used_at DATETIME NULL
- created_at DATETIME
- 唯一约束：(owner_account_id, coop_account_id)

## 6. 算法设计（调度选配）
1) 触发与匹配时机
- 调度器仍按时间策略为普通账号创建“勾协任务”；但目标勾协库账号的匹配发生在任务“执行阶段”，只有在执行过程中检测到确有“勾协”时才进行匹配与下发“接受勾协”子任务。

2) 基础过滤
- 发起方：GameAccount.status=1 且 progress=ok，任务配置开启勾协。
- 目标：CoopAccount.status=1。

3) 时间窗限流（容量=2）
- 计算当前窗口 (window_date, slot)。
- 左连接 CoopWindow，得到 used_count（无行视为0）。
- 仅选择 used_count < 2 的目标账号。

4) 历史优先 + 均衡
- 首选：在 CoopPool 中与该 owner 有历史配对的 coop，且当前窗口未满（used_count<2），按 last_used_at 升序、CoopWindow.used_count 升序。
- 其次：在全量候选中按 CoopWindow.used_count 升序，last_used_at 升序进行选择。
- 同一进程调度周期内，对同一 coop 还需考虑本次循环内的临时占用数，避免超过2。

5) 占用与一致性（更新为“成功后计数”）
- 执行阶段仅做“软占用/内存占位”（可选）：为了避免同窗内被并发抢占超过2次，执行器在发起“接受勾协”子任务前，需检查 used_count + inflight_accepts < 2；inflight_accepts 为当前进程内该 coop 在本窗的进行中数量。
- 仅当“接受勾协”子任务执行成功后，才持久化更新 CoopWindow.used_count += 1；并在达到2时可写入 completed_at。
- 多实例并发的情况下，需引入“接受记录表/唯一约束”或“条件更新 + 受影响行数=1”的方式保障并发一致性；本期单实例可先采用内存占位方案。

6) 任务条件
- Task.conditions 写入 `{coop_account_id, coop_login_id, window:{date,slot}}`。

7) 成功回写
- 执行成功后：CoopPool.used_count += 1，last_used_at=now（若无则创建）。
- 更新 owner 账号的 task_config["勾协"].next_time 为下一窗口起点（或按 COOP_TIMES）。

8) 资源绑定（勾协专用模拟器）
- “接受勾协”子任务仅指派给 `role=coop` 的 Worker/Emulator；普通“owner 勾协任务”仍由 general 角色可执行。

## 7. API 设计（后端）
路由前缀：`/api/coop`
- GET `/accounts`：列表 + 当前窗口用量
- POST `/accounts`：创建
- PUT `/accounts/{id}`：更新
- DELETE `/accounts/{id}`：删除
- POST `/accounts/batch-import`：批量导入

## 8. 前端页面（/coop）
- 顶部：新增/批量导入、搜索（登录ID实时过滤）。
- 表格：登录ID、状态（开关）、当前窗口用量（x/2）、是否完成（used==2）、备注、创建时间、操作。

## 9. 测试计划
- 单元：CoopAccount CRUD；CoopWindow 窗口计算与容量；选配算法（历史优先、均衡、容量限制）。
- 集成：到点创建勾协任务、每窗口最多2次、窗口切换自然归零；执行成功后亲和回写。

## 10. 实施步骤
1) 已完成：数据表与 /api/coop 路由；SQLite 自动重建 coop_pools。
2) 本迭代：接入调度选配算法与窗口占用；更新 COOP_TIMES 默认到 "12:00,18:00"。
3) 下一迭代：前端 /coop 页面；仪表盘增加勾协窗口统计（可选）。

## 11. 风险与约束
- 多实例并发需升级为事务化占用；本期单实例即可。
- 时区按服务器本地时间（推荐 UTC+8）。
- 历史旧配对数据不迁移（按产品决策）。
